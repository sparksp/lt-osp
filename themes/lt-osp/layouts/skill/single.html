{{ define "main" -}}
<article>
    <h1>{{ .Title }}</h1>

    {{- $names := slice (print .File.Dir .File.ContentBaseName | replaceRE "^skill/" "") }}
    {{- $lists := slice }}
    {{- with .Params.lists }}{{ $lists = $lists | append . }}{{ end }}
    {{- range (print .File.Dir .File.ContentBaseName | where site.RegularPages ".Params.canonical") }}
    {{- $child := . }}
    {{- if .Param "canonical" }}{{ with (.Param "canonical" | site.GetPage ) }}
    {{- $child = . }}
    {{- end }}{{ end }}
    {{- $names = $names | append (print $child.File.Dir $child.File.ContentBaseName | replaceRE "^skill/" "") }}
    {{- with .Params.lists }}{{ $lists = $lists | append . }}{{ end }}
    {{- end }}

    {{- $dependents := slice }}
    {{ range (where site.RegularPages ".Params.prerequisites" "intersect" $names) -}}
    {{ $skill := . }}
    {{- if .Param "canonical" }}{{ with (.Param "canonical" | site.GetPage ) }}
    {{ $skill = . }}
    {{- end }}{{ end }}
    {{ $dependents = $dependents | append $skill }}
    {{- end }}

    {{- with ($lists | sort | uniq) }}
    {{- $lists := site.GetPage "/lists" }}
    <p>
        {{- $len := len . }}
        <strong>List{{ if ne $len 1 }}s{{ end }}:</strong>
        {{- range $index, $e := . }}
        {{- if $index }}
        {{- if ge (add $index 1) $len }} and {{ else }}, {{ end }}
        {{- end }}
        {{ $lists.GetPage . | partial "lists/link" }}
        {{- end }}.
    </p>
    {{- end }}

    {{- with .Params.tier }}<p><strong>Tier:</strong> {{ . }}</p>{{ end -}}

    {{- with .Params.min_type }}<p><strong><abbr title="Minimum">Min.</abbr> Type:</strong> {{ partial "skill/link" . }}</p>{{ end -}}

    {{- with .Params.osp_cost }}<p><strong>OSP Cost:</strong> {{ . }}</p>{{ end -}}

    {{- with .Params.prerequisites }}
    <p>
        <strong>Pre-requisite to learn:</strong>
        {{ range $item := . -}}
        {{ partial "skill/link" . }}
        {{- end }}.
    </p>
    {{- end }}

    {{- with .Params.requirements }}
    <p>
        <strong>Requirements to use:</strong>
        {{ range $item := . -}}
        {{ partial "skill/link" . }}
        {{- end }}.
    </p>
    {{- end }}

    {{ with (sort (uniq $dependents) "Params.tier") -}}
    <p>
        {{- $len := len . }}
        <strong>Dependent skill{{ if ne $len 1 }}s{{ end }}:</strong>
        {{- range $index, $e := . }}
        {{- if $index }}
        {{- if ge (add $index 1) $len }} and {{ else }}, {{ end }}
        {{- end }}
        <a href="{{ .Permalink }}" title="{{ .Title }}">{{ .LinkTitle }}</a>
        {{- end }}.
    </p>
    {{- end }}

    {{ .Render "content" }}

    {{- if .Param "canonical" }}{{- with (.Param "canonical" | string | site.GetPage) }}
    <p>See <a href="{{ .Permalink }}" rel="parent">{{ .Title }}</a> for full details.</p>
    {{- end }}{{- end }}
</article>
{{- end }}